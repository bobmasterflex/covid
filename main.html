<!doctype html>
<html>

<head>
    <title>COVID-19 Charts</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="Chart.min.js"></script>
    <script src="utils.js"></script>
    <script>
    var allStateCodes = ["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"];
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}    
    </script>
    <style>
    canvas{
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }
	.primary{
	  height: 100%;
	  width: 100%;
	  position: fixed;
	  background: white;
	  top: 0;
	  z-index: 100;
	}
	.mini { height:400px;width:49%;float:left; }
	.stLetters { background-color: white; font-family: monospace; font-size:large; }
.box {
  background: #666666;
  color: #ffffff;
  width: 250px;
  padding: 10px;
  margin: 1em auto;
}
p {
  margin: 1.5em 0;
  padding: 0;
}
#stateCheckboxes input[type="checkbox"] {
  display: none;
}
label {
  cursor: pointer;
  margin-right: 10px;
}
#stateCheckboxes input[type="checkbox"] + label:before {
  /* border: 1px solid #333; */
  content: "\00a0";
  display: inline-block;
  font-size: 22px;
  height: 16px;
  margin: -8px 0 0 0;
  padding: 0;
  vertical-align: top;
  width: 16px;
}
#stateCheckboxes input[type="checkbox"]:checked + label:before {
  /* background: #fff; */
  color: white;
  content: "\2713";
  text-align: center;
  
}
#stateCheckboxes input[type="checkbox"]:checked + label:after {
  font-weight: bold;
}

#stateCheckboxes input[type="checkbox"]:focus + label::before {
    outline: rgb(59, 153, 252) auto 5px;
}	
    </style>
</head>

<body>
<h3>
Update Nov 7: Some state data stops a few days early. Therefore the US data is skewed for recent days, making it look like steep declines in deaths and cases per day.
</h3>
<h3> Update Nov 2: Newsbreak has restored their earlier API!
</h3>
	<div style="width:717px;">
    <div>States Loaded:<span id="statesDone">0</span>
	<br><textarea rows="4" cols="100" id="stateList"></textarea><br>
		<div style="float:left">
			<button id="setStates">Set States</button>
			<button id="onAllStates">All On</button>
			<button id="offAllStates">All Off</button>
		</div>
		<div style="float:right">
			<select id="startDate"></select>
			<select id="endDate"></select>
			<button id="setPeriod">Set Date Period</button>
		</div>
<br>		
	</div>
    </div>
	</div>
	<br>
	<div id="stateCheckboxes">
	</div>
	<div id="covidConfigControls">
		<div id="chartViewControls">
		  <input type="checkbox" checked="checked" id="hD" hideClass="deaths"><label><span class="stLetters">Hide Deaths</span></label>
		  <input type="checkbox" checked="checked" id="hC" hideClass="cases"><label><span class="stLetters">Hide Cases</span></label>
		  |
		  <input type="checkbox" checked="checked" id="hP" hideClass="daily"><label><span class="stLetters">Hide Per Day</span></label>
		  <input type="checkbox" checked="checked" id="hT" hideClass="total"><label><span class="stLetters">Hide Totals</span></label>
		  |
		  <input type="checkbox" checked="checked" id="hR" hideClass="raw"><label><span class="stLetters">Hide Raw</span></label>
		  <input type="checkbox" checked="checked" id="hM" hideClass="capita"><label><span class="stLetters">Hide Per Capita / Million</span></label>
		  |
		  <input type="checkbox" checked="checked" id="hE" hideClass="dpc"><label><span class="stLetters">Hide % Deaths/Case</span></label>
		</div>
		<div id="">
		  <input type="checkbox" id="r7" checked="checked"><label><span class="stLetters">Use 7 Day Rolling Average Instead of Raw Daily Numbers (Only per day, does not affect graphs with totals)</span><a href="#info7day">Why?</a></label>
		</div>
		<div id="">
		  <input type="checkbox" id="hU" checked="checked"><label><span class="stLetters">Hide US On Raw Data</span></label>
		</div>
		<div id="chartAxisLimits">
		  <input type="checkbox" id="uZ" checked="checked"><label><span class="stLetters">Use Zero as Minimum</span></label><a href="#infoAxisLimits">What?</a>
		</div>
		<div id="myGeneratedUrlDiv">Direct link to this view:<br>
		  <a id="myGeneratedUrlLink" href=""></a><br><br>
		</div>
	</div>
	<div id="spikeExplain">
      <a href="#infoAxisLimits">What's with the huge spikes in numbers?</a>
	</div>
    <div style="width:99%;" id="allCharts">
      <div class="mini deaths daily raw" style="display:none">
        <canvas id="canvasDeathEveryone"></canvas>
      </div>
      <div class="mini cases daily raw" style="display:none">
        <canvas id="canvasCasesEveryone"></canvas>
      </div>
      <div class="mini deaths daily capita" style="display:none">
        <canvas id="canvasDeathEveryoneNDPM"></canvas>
      </div>
      <div class="mini cases daily capita" style="display:none">
        <canvas id="canvasCasesEveryoneNDPM"></canvas>
      </div>
      <div class="mini deaths total raw" style="display:none">
        <canvas id="canvasDeathEveryoneTotalRaw"></canvas>
      </div>
      <div class="mini cases total raw" style="display:none">
        <canvas id="canvasCasesEveryoneTotalRaw"></canvas>
      </div>
      <div class="mini deaths total capita" style="display:none">
        <canvas id="canvasDeathEveryoneTotalPerCapita"></canvas>
      </div>
      <div class="mini cases total capita" style="display:none">
        <canvas id="canvasCasesEveryoneTotalPerCapita"></canvas>
      </div>
	  <div class="dpc" style="width:100%;height:500px;float:left;display:none;">
        <canvas id="canvasEveryoneallDatasets_DpcTotal"></canvas>
	  </div>
	  <div class="dpc" style="width:100%;height:500px;float:left;display:none;">
        <canvas id="canvasEveryoneallDatasets_DpcRolling"></canvas>
	  </div>
    </div>
    <br>
    <br>
    <script>
jQuery(document).ready(function(){
  jQuery("#chartViewControls input").click(resetHiders);
  jQuery("#hU").click(updateAll);
  setAllStatesTextarea();
  
  var stateCode = "US";
  jQuery("#stateCheckboxes").append(
	jQuery('<input type="checkbox" checked="checked" id="statecb' + stateCode + '" name="' + stateCode + '" value="' + stateCode + '"><label style="background:'+getStateColor(stateCode)+'" for="statecb' + stateCode + '"><span class="stLetters">' + stateCode + '</span></label>')
  );
  for (i = 0; i < allStateCodes.length; i++){
    var stateCode = allStateCodes[i];
	jQuery("#stateCheckboxes").append(
	  jQuery('<input type="checkbox" checked="checked" id="statecb' + stateCode + '" name="' + stateCode + '" value="' + stateCode + '"><label style="background:'+getStateColor(stateCode)+'" for="statecb' + stateCode + '"><span class="stLetters">' + stateCode + '</span></label>')
	);
	if ((i+1) % 17 == 16){
		jQuery("#stateCheckboxes").append(
		  jQuery('<br><br>')
		);
	}
  }
  jQuery("#stateCheckboxes input").click(function(a){stateClicked(a);});
  jQuery("#setStates").click(function(a){setStatesByTextarea();});
  jQuery("#onAllStates").click(function(a){setAllStatesTextarea();setStatesByTextarea();});
  jQuery("#offAllStates").click(function(a){jQuery("#stateList").val("");setStatesByTextarea();});
  jQuery("input").click(function(){generateUrl();});
  jQuery("button").click(function(){generateUrl();});
});
function dec2bin(dec){
    return (dec >>> 0).toString(2);
}

generateUrl = function(){
	/*
	var allStatesChecked = [];
	jQuery("#stateCheckboxes input:checked").each(function(a, b){
		allStatesChecked.push(jQuery(b).val());
	});
	allStatesConfigLine = allStatesChecked.join("|");
	*/
	
	var packedStates = "";	
	var binRep = "";
	jQuery("#stateCheckboxes input").each(function(a, b){
		if (jQuery(b).is(":checked")){
			binRep += "1";
		}else{
			binRep += "0";
		}
	});
	binRep = binRep.padStart(52, '0');
	//console.log("orig:"+binRep);
	var binRepSections = binRep.match(/.{1,4}/g);
	for(brsi = 0; brsi < binRepSections.length; brsi++){
	var myItem = parseInt(binRepSections[brsi], 2);
	var currLetter = (String.fromCharCode(65 + myItem));
		packedStates += (currLetter);
	}
	allStatesConfigLine = packedStates;
	//console.log("pack:"+packedStates);
	
	var optionsToTurnOffList = [];
	jQuery("#covidConfigControls input:checkbox:not(:checked)").each(function(a, b){
		optionsToTurnOffList.push(jQuery(b).attr('id'));
	});
	optionsToTurnOffList.reverse();
	optionsToTurnOffLine = optionsToTurnOffList.join("8");	
	
	var linkValue = window.location.origin + window.location.pathname + "?config=";
	linkValue += allStatesConfigLine + "*" + optionsToTurnOffLine;

	linkValue += "*";
	var stsi = jQuery("#startDate").prop('selectedIndex');
	linkValue += String.fromCharCode(Math.floor(stsi/26) + 65);
	linkValue += String.fromCharCode(Math.floor(stsi%26) + 65);
	
	var etsi = jQuery("#endDate").prop('selectedIndex');
	linkValue += String.fromCharCode(Math.floor(etsi/26) + 65);
	linkValue += String.fromCharCode(Math.floor(etsi%26) + 65);
	
	jQuery("#myGeneratedUrlLink").attr('href', linkValue).text(linkValue);
	
}
setConfig = function(covidConfig){
	// covid config is a string broken up into:
	// states that are pipe delimited
	// star
	// checked ids pipe delimied
	var splitter = covidConfig.split("*");
	if (splitter.length > 1){
		var packedStates = splitter[0];
		var checkedImploded = splitter[1];
		var packedDates = "";
		if (splitter.length > 2){
			packedDates = splitter[2];
		}
		checked = checkedImploded.split("8");
		createCharts();
		var binStringTotal = "";
		for(psi = 0; psi < packedStates.length; psi++){
			var code = (packedStates.charCodeAt(psi));
			code = code - 65;
			binStringSection = dec2bin(code);
			binStringSection = binStringSection.padStart(4,'0');
			binStringTotal += binStringSection;
		}		
		var myUnusedBinString = binStringTotal;
		var myOutput = [];
		for (var asci = 1; asci <= allStateCodes.length; asci++){
			var currCheck = myUnusedBinString.substring(myUnusedBinString.length-1);
			myUnusedBinString = myUnusedBinString.substring(0, myUnusedBinString.length-1);
			if (currCheck == "1"){
				myOutput.unshift(allStateCodes[allStateCodes.length - asci]);
			}
		}
		currCheck = myUnusedBinString.substring(myUnusedBinString.length-1);
		if (currCheck == "1"){
			myOutput.unshift("US");
		}
		commaDelimStates = myOutput.join(", ");		
		jQuery("textarea").val(commaDelimStates);
		setStatesByTextarea();
		for (var ci = 0; ci < checked.length; ci++){
			if (checked[ci].length > 0){
				jQuery("#" + checked[ci]).click();
			}
		}
		useSensibleAxisLimits();
		console.log("Packed Dates:" + packedDates);
		if (packedDates.length == 4){
			startDateIndex = (packedDates.charCodeAt(0) - 65) * 26 + (packedDates.charCodeAt(1) - 65);
			endDateIndex = (packedDates.charCodeAt(2) - 65) * 26 + (packedDates.charCodeAt(3) - 65);
			jQuery("#startDate").prop('selectedIndex', startDateIndex);
			jQuery("#endDate").prop('selectedIndex', endDateIndex);
		}
		loadDateSet();
	}
}
setAllStatesTextarea = function(){
  jQuery("#stateList").val("US");
  var toAdd = ", ";
  for (i = 0; i < allStateCodes.length; i++){
    var stateCode = allStateCodes[i];
	jQuery("#stateList").val(jQuery("#stateList").val() + toAdd + stateCode);
  }
}
setStatesByTextarea = function(){
  var tat = jQuery("textarea").val();
  tat.split(",");
  var stateCodePortion = tat.split(",");
  setStateCodes = [];
  stateCodePortion.forEach(function(a, b){
    var stateCode = a.trim();
	setStateCodes.push(stateCode);
  });
  setStates(setStateCodes);
  setStateCBs(setStateCodes);
  useUsOnRaw();
}
setTextareaByCB = function(){
  var toAdd = "";
  var toUse = "";
  jQuery("#stateCheckboxes input:checked").each(function(a, b){
    var stateCode = jQuery(b).attr("name");
  	toUse += toAdd + stateCode;
	toAdd = ", ";
  });
  jQuery("textarea").val(toUse);
}
useUsOnRaw = function(){
	if (jQuery("#statecbUS:checked").length == 1){
		var hideUs = (jQuery("#hU:checked").length == 1);
		setStateByChart(window.charts.canvasCasesEveryone, 'US', !hideUs);
		setStateByChart(window.charts.canvasDeathEveryone, 'US', !hideUs);
		setStateByChart(window.charts.canvasCasesEveryoneTotalRaw, 'US', !hideUs);
		setStateByChart(window.charts.canvasDeathEveryoneTotalRaw, 'US', !hideUs);
	}
}
resetHiders = function(){
  hideThese = jQuery("#chartViewControls input:checked");
  jQuery("canvas").parent().show();
  jQuery(".mini").css("width", "49%");
  for(hti=0; hti<hideThese.length; hti++){
    var hideclass = hideThese[hti].getAttribute("hideclass");
	jQuery("."+hideclass).hide();
	if (hideclass == "cases" || hideclass == "deaths"){
        jQuery(".mini").css("width", "99%");
		
	}
  }
  sleep(100);
  Object.keys(window.charts).forEach(function(val, index){
    if (jQuery(window.charts[val].canvas).is(":visible")){
	  window.charts[val].resize();
	}
  });
}
turnOnStates = function(myChart, stateCodeArray, suppressUpdate){
  for (var i = 0; i < myChart.data.datasets.length; i++){
    if (stateCodeArray.includes(myChart.data.datasets[i].label)){
	  var ignores7dayCB = (typeof myChart.data.datasets[i].ignores7dayCB != 'undefined') && myChart.data.datasets[i].ignores7dayCB;
	  
	  if (typeof(myChart.data.datasets[i].isRolling) == "boolean" && !ignores7dayCB){
		var useRolling = jQuery("#r7:checked").length == 1;
		if (myChart.data.datasets[i].isRolling && useRolling){
		   myChart.getDatasetMeta(i).hidden = false;
		}else if(!myChart.data.datasets[i].isRolling && !useRolling){
		   myChart.getDatasetMeta(i).hidden = false;
		}
	  }else{
		myChart.getDatasetMeta(i).hidden = false;
	  }
    }
  }
  if (typeof(suppressUpdate) != 'boolean' || !suppressUpdate){
	myChart.update();
  }
}
turnOffStates = function(myChart, stateCodeArray, suppressUpdate){
  for (var i = 0; i < myChart.data.datasets.length; i++){
    if (stateCodeArray.includes(myChart.data.datasets[i].label)){
      myChart.getDatasetMeta(i).hidden = true;
    }
  }
  if (typeof(suppressUpdate) != 'boolean' || !suppressUpdate){
	myChart.update();
  }

}
toggle = function(myChart){
  for (var i = 0; i < myChart.data.datasets.length; i++){
    myChart.getDatasetMeta(i).hidden = !myChart.getDatasetMeta(i).hidden;
  }
  myChart.update();
}
turnOn = function(myChart){
  for (var i = 0; i < myChart.data.datasets.length; i++){
    myChart.getDatasetMeta(i).hidden = false;
  }
  myChart.update();
}
turnOff = function(myChart){
  for (var i = 0; i < myChart.data.datasets.length; i++){
    myChart.getDatasetMeta(i).hidden = true;
  }
  myChart.update();
}
window.statepop = Array();
statepop['US'] =331494238
statepop['CA'] =39512223
statepop['TX'] =28995881
statepop['FL'] =21477737
statepop['NY'] =19453561
statepop['PA'] =12801989
statepop['IL'] =12671821
statepop['OH'] =11689100
statepop['GA'] =10617423
statepop['NC'] =10488084
statepop['MI'] =9986857
statepop['NJ'] =8882190
statepop['VA'] =8535519
statepop['WA'] =7614893
statepop['AZ'] =7278717
statepop['MA'] =6949503
statepop['TN'] =6833174
statepop['IN'] =6732219
statepop['MO'] =6137428
statepop['MD'] =6045680
statepop['WI'] =5822434
statepop['CO'] =5758736
statepop['MN'] =5639632
statepop['SC'] =5148714
statepop['AL'] =4903185
statepop['LA'] =4648794
statepop['KY'] =4467673
statepop['OR'] =4217737
statepop['OK'] =3956971
statepop['CT'] =3565287
statepop['UT'] =3205958
statepop['IA'] =3155070
statepop['PR'] =3193694
statepop['NV'] =3080156
statepop['AR'] =3017825
statepop['MS'] =2976149
statepop['KS'] =2913314
statepop['NM'] =2096829
statepop['NE'] =1934408
statepop['ID'] =1787065
statepop['WV'] =1792147
statepop['HI'] =1415872
statepop['NH'] =1359711
statepop['ME'] =1344212
statepop['MT'] =1068778
statepop['RI'] =1059361
statepop['DE'] =973764
statepop['SD'] =884659
statepop['ND'] =762062
statepop['AK'] =731545
statepop['DC'] =705749
statepop['VT'] =623989
statepop['WY'] =578759

window.catchUpDays = [];
catchUpDays['NY'] = [
	{
		day:'04/17',
		type:'death',
	},{
		day:'05/06',
		type:'death'
	},{
		day:'05/11',
		type:'cases'
	},{
		day:'05/25',
		type:'death'
	},{
		day:'07/01',
		type:'death'
	}
];
catchUpDays['NJ'] = [
	{
		day:'06/25',
		type:'death'
	}
];
catchUpDays['AR'] = [
	{
		day:'09/16',
		type:'death'
	}
];
catchUpDays['TX'] = [
	{
		day:'07/27',
		type:'death'
	},
	{
		day:'09/21',
		type:'cases'
	}
];
catchUpDays['MA'] = [
	{
		day:'09/07',
		type:'cases'
	}
];
catchUpDays['AL'] = [
	{
		day:'09/11',
		type:'death'
	}
];
catchUpDays['DE'] = [
	{
		day:'06/12',
		type:'death'
	}
];
catchUpDays['LA'] = [
	{
		day:'06/08',
		type:'death'
	}
];
catchUpDays['WV'] = [
	{
		day:'04/02',
		type:'cases',
		specialText:'Data between total and a calculated day by day aggregate breaks on this day. This is an issue with the data source. The data show on this day is as it appears as listed in totals data'
	}
];
    
        window.allDatasets_deathsPerDayRaw = [];
        window.allDatasets_casesPerDayRaw = [];
        window.allDatasets_deathsPerDayRawPerCapita = [];
        window.allDatasets_casesPerDayRawPerCapita = [];
        window.allDatasets_DeathsTotal = [];
        window.allDatasets_CasesTotal = [];
        window.newDeathsPerCapita = [];
        window.newCasesPerCapita = [];
        window.allDatasets_DpcTotal = [];
		window.allDatasets_DpcRolling = [];
                
        
        getStateColor = function(s){
          if (s == "") return "rgb(0,0,0)";
          if (s == "US") return "rgb(0,0,0)";
          var a = s.charCodeAt(0) - 64;
          var b = s.charCodeAt(1) - 64;
          var af = Math.floor(55 + (a * 150) / 26);
          var bf = Math.floor(85 + (b * 100) / 26);
          var cf = Math.floor(((a + b) * 256) / 26) % 256;
          return "rgb(" + af + ", " + bf + ", " + cf + ")";
        }
        async function doAllStates(){
			window.charts = {};
            window.numStatesDone = 0;
            for(dosi = 0; dosi < allStateCodes.length; dosi++){
                var currStateCode = allStateCodes[dosi];
                doState(currStateCode);
                await sleep(5); // Usually enough to ensure they are in alphabetical order on the chart
            }
            var start = new Date();
            console.log("Try 1  numStatesDone:" + window.numStatesDone);
			// attempt to get the missing items if any
			var loadedStates = [];
			var tryNumber = 2;
			while (tryNumber < 10 && window.numStatesDone < 50){
				await sleep(500);
				
				window.allDatasets_CasesTotal.forEach(function(a, b){
					loadedStates.push(a.label);
				});
				var missingStates = window.allStateCodes.filter(x => !loadedStates.includes(x));
				for(dosi = 0; dosi < missingStates.length; dosi++){
					var currStateCode = missingStates[dosi];
					console.log("Missed:" + currStateCode);
					doState(currStateCode);
					await sleep(5);
				}
				console.log("Try "+tryNumber+"  numStatesDone:" + window.numStatesDone);
				tryNumber++;
			}

			
			
			jQuery("#uZ").click(function(){useSensibleAxisLimits();});
			jQuery("#r7").click(function(){useRollingAverages();});
            window.usData = getBaseConfig("", "US Data");
            usData.data.datasets[0].label = "US";
            usData.data.datasets[0].deathPercentCasesTotal = [];
			usData.data.datasets[0].caseTotal = [];
			usData.data.datasets[0].deathTotal = [];
			usData.data.datasets[0].caseTPC = [];
			usData.data.datasets[0].deathTPC = [];
            for(var adi = 0; adi < 50; adi++){
              for (var adid = 0; adid < window.allDatasets_DpcTotal[adi].data.length; adid++){
                if (adi == 0) { 
				  // If the index for the day doesn't exist yet, set it to zero
                  usData.data.datasets[0].caseTotal[adid] = usData.data.datasets[0].deathTotal[adid] = usData.data.datasets[0].deathPercentCasesTotal[adid] = 0;
                  usData.data.datasets[0].caseTPC[adid] = usData.data.datasets[0].deathTPC[adid] = 0;
                }
                usData.data.datasets[0].caseTotal[adid] += window.allDatasets_DpcTotal[adi].caseTotal[adid];
				usData.data.datasets[0].caseTPC[adid] = usData.data.datasets[0].caseTotal[adid] / statepop['US'];
				usData.data.datasets[0].caseTPC[adid] = usData.data.datasets[0].caseTPC[adid].toFixed(8);
                usData.data.datasets[0].deathTotal[adid] += window.allDatasets_DpcTotal[adi].deathTotal[adid];
				usData.data.datasets[0].deathTPC[adid] = usData.data.datasets[0].deathTotal[adid] / statepop['US'];
				usData.data.datasets[0].deathTPC[adid] = usData.data.datasets[0].deathTPC[adid].toFixed(8);
				if (usData.data.datasets[0].caseTotal[adid] != 0){
					usData.data.datasets[0].deathPercentCasesTotal[adid] = ((100 * usData.data.datasets[0].deathTotal[adid]) / usData.data.datasets[0].caseTotal[adid]).toFixed(8);
				} else{
					usData.data.datasets[0].deathPercentCasesTotal[adid] = 0;
				}
              }
            }
			usData.data.datasets[0].casesRollingRaw = [];
			usData.data.datasets[0].casesPerDayRaw = [];
			usData.data.datasets[0].deathsRollingRaw = [];
			usData.data.datasets[0].deathsPerDayRaw = [];
			usData.data.datasets[0].casesRollingPM = [];
			usData.data.datasets[0].casesPerDayPM = [];
			usData.data.datasets[0].deathsRollingPM = [];
			usData.data.datasets[0].deathsPerDayPM = [];
            for(var adi = 0; adi < 100; adi++){
              for (var adid = 0; adid < window.allDatasets_casesPerDayRaw[adi].data.length; adid++){
                if (adi == 0) { 
				  // If the index for the day doesn't exist yet, set it to zero
                  usData.data.datasets[0].casesPerDayRaw[adid] = usData.data.datasets[0].deathsPerDayRaw[adid] = 0;
                  usData.data.datasets[0].casesRollingRaw[adid] = usData.data.datasets[0].deathsRollingRaw[adid] = 0;
                  usData.data.datasets[0].casesPerDayPM[adid] = usData.data.datasets[0].deathsPerDayPM[adid] = 0;
                  usData.data.datasets[0].casesRollingPM[adid] = usData.data.datasets[0].deathsRollingPM[adid] = 0;
                }
				if (window.allDatasets_casesPerDayRaw[adi].isRolling){
					usData.data.datasets[0].casesRollingRaw[adid] += parseFloat(window.allDatasets_casesPerDayRaw[adi].data[adid]);
					usData.data.datasets[0].casesRollingPM[adid] = usData.data.datasets[0].casesRollingRaw[adid] / (statepop['US'] / 1000000);
					usData.data.datasets[0].casesRollingPM[adid] = usData.data.datasets[0].casesRollingPM[adid].toFixed(4);
				} else {
					usData.data.datasets[0].casesPerDayRaw[adid] += window.allDatasets_casesPerDayRaw[adi].data[adid];
					usData.data.datasets[0].casesPerDayPM[adid] = usData.data.datasets[0].casesPerDayRaw[adid] / (statepop['US'] / 1000000);
					usData.data.datasets[0].casesPerDayPM[adid] = usData.data.datasets[0].casesPerDayPM[adid].toFixed(4);
				}
				if (window.allDatasets_deathsPerDayRaw[adi].isRolling){
					usData.data.datasets[0].deathsRollingRaw[adid] += parseFloat(window.allDatasets_deathsPerDayRaw[adi].data[adid]);
					usData.data.datasets[0].deathsRollingPM[adid] = usData.data.datasets[0].deathsRollingRaw[adid] / (statepop['US'] / 1000000);
					usData.data.datasets[0].deathsRollingPM[adid] = usData.data.datasets[0].deathsRollingPM[adid].toFixed(4);
				}else{
					usData.data.datasets[0].deathsPerDayRaw[adid] += window.allDatasets_deathsPerDayRaw[adi].data[adid];
					usData.data.datasets[0].deathsPerDayPM[adid] = usData.data.datasets[0].deathsPerDayRaw[adid] / (statepop['US'] / 1000000);
					usData.data.datasets[0].deathsPerDayPM[adid] = usData.data.datasets[0].deathsPerDayPM[adid].toFixed(4);
				}
				// If we're done then give this day a nicer numbers to display
				if (adi == 99){
					usData.data.datasets[0].deathsRollingRaw[adid] = usData.data.datasets[0].deathsRollingRaw[adid].toFixed(4);
					usData.data.datasets[0].casesRollingRaw[adid] = usData.data.datasets[0].casesRollingRaw[adid].toFixed(4);
				}
              }
            }
			var searchParams = new URLSearchParams(window.location.search);
			initiateDateSet();
			jQuery("#setPeriod").click(function(){
				loadDateSet();
				generateUrl();
			});
			// All data was taking a bit to load. Gives a bad first impression
			var configToLoad = "EACAAEAAAAAIA*hE8hM8hR8hP8hC8hD";//"HPPPPPPPPPPPP" + "*hD8hR8hP8hC8hE";
			if (searchParams.has('config')){
				configToLoad = searchParams.get('config');
			}
			
			setConfig(configToLoad);
			generateUrl();
		}
		initiateDateSet = function(){
			var currDate = "";
			for(var wali = 0; wali < window.allLabels.length; wali++){
				currDate = window.allLabels[wali];
				jQuery("#startDate").append("<option>" + currDate + "</option>");
				jQuery("#endDate").append("<option>" + currDate + "</option>");
			}
			jQuery("#endDate").val(currDate);
		}
		loadDateSet = function(){
			var sd = jQuery("#startDate").val();
			var ed = jQuery("#endDate").val();
			Object.keys(window.charts).forEach(function(val, index){
				window.charts[val].config.options.scales.xAxes[0].ticks.min = sd;
				window.charts[val].config.options.scales.xAxes[0].ticks.max = ed;
			});
			updateAll();
		}
		createCharts = function(){
            var config = getBaseConfig("  ", "Deaths per day");
			var pullFrom = getBaseConfig("US","US Deaths rolling", usData.data.datasets[0].deathsRollingRaw.slice());
			pullFrom.data.datasets[0].isDeath = true;
			pullFrom.data.datasets[0].isRolling = true;
			pullFrom.data.datasets[0].hidden = true;
            window.allDatasets_deathsPerDayRaw.unshift(pullFrom.data.datasets[0]);
			var pullFrom = getBaseConfig("US","US Deaths per day", usData.data.datasets[0].deathsPerDayRaw.slice());
			pullFrom.data.datasets[0].isDeath = true;
			pullFrom.data.datasets[0].isRolling = false;
			pullFrom.data.datasets[0].hidden = true;
            window.allDatasets_deathsPerDayRaw.unshift(pullFrom.data.datasets[0]);
            config.data.datasets = window.allDatasets_deathsPerDayRaw;
			config = addCatchUpDayWarning(config);
            config.data.labels = window.allLabels;
            var canvasId = "canvasDeathEveryone";
            var ctx = document.getElementById(canvasId).getContext('2d');
            window.charts[canvasId] = new Chart(ctx, config);

            var config = getBaseConfig("  ", "Cases per day");
			var pullFrom = getBaseConfig("US","US Cases rolling", usData.data.datasets[0].casesRollingRaw.slice());
			pullFrom.data.datasets[0].isCases = true;
			pullFrom.data.datasets[0].isRolling = true;
			pullFrom.data.datasets[0].hidden = true;
            window.allDatasets_casesPerDayRaw.unshift(pullFrom.data.datasets[0]);
			var pullFrom = getBaseConfig("US","US Cases per day", usData.data.datasets[0].casesPerDayRaw.slice());
			pullFrom.data.datasets[0].isCases = true;
			pullFrom.data.datasets[0].isRolling = false;
			pullFrom.data.datasets[0].hidden = true;
            window.allDatasets_casesPerDayRaw.unshift(pullFrom.data.datasets[0]);
            config.data.datasets = window.allDatasets_casesPerDayRaw;
			config = addCatchUpDayWarning(config);
            config.data.labels = window.allLabels;
            var canvasId = "canvasCasesEveryone";
            var ctx = document.getElementById(canvasId).getContext('2d');
            window.charts[canvasId] = new Chart(ctx, config);

            var config = getBaseConfig("  ", "Total Deaths Per Capita for each state's population");
			config = addPercentOfToday(config);
			var pullFrom = getBaseConfig("US","US Deaths Per Capita", usData.data.datasets[0].deathTPC.slice());
            window.allDatasets_deathsPerDayRawPerCapita.unshift(pullFrom.data.datasets[0]);
            config.data.datasets = window.allDatasets_deathsPerDayRawPerCapita;
			config = addCatchUpDayWarning(config);
            config.data.labels = window.allLabels;
            var canvasId = "canvasDeathEveryoneTotalPerCapita";
            var ctx = document.getElementById(canvasId).getContext('2d');
            window.charts[canvasId] = new Chart(ctx, config);

            var config = getBaseConfig("  ", "Total Cases Per Capita for each state's population");
			config = addPercentOfToday(config);
			var pullFrom = getBaseConfig("US","US Cases Per Capita", usData.data.datasets[0].caseTPC.slice());
            window.allDatasets_casesPerDayRawPerCapita.unshift(pullFrom.data.datasets[0]);
            config.data.datasets = window.allDatasets_casesPerDayRawPerCapita;
			config = addCatchUpDayWarning(config);
            config.data.labels = window.allLabels;
            var canvasId = "canvasCasesEveryoneTotalPerCapita";
            var ctx = document.getElementById(canvasId).getContext('2d');
            window.charts[canvasId] = new Chart(ctx, config);

            var config = getBaseConfig("  ", "Total Deaths");
			config = addPercentOfToday(config);
			var pullFrom = getBaseConfig("US","US Total Deaths", usData.data.datasets[0].deathTotal.slice());
			pullFrom.data.datasets[0].hidden = true;
            window.allDatasets_DeathsTotal.unshift(pullFrom.data.datasets[0]);
            config.data.datasets = window.allDatasets_DeathsTotal;
			config = addCatchUpDayWarning(config);
            config.data.labels = window.allLabels;
            var canvasId = "canvasDeathEveryoneTotalRaw";
            var ctx = document.getElementById(canvasId).getContext('2d');
            window.charts[canvasId] = new Chart(ctx, config);

            var config = getBaseConfig("  ", "Total Cases");
			config = addPercentOfToday(config);
			var pullFrom = getBaseConfig("US","US Total Cases", usData.data.datasets[0].caseTotal.slice());
			pullFrom.data.datasets[0].hidden = true;
            window.allDatasets_CasesTotal.unshift(pullFrom.data.datasets[0]);
            config.data.datasets = window.allDatasets_CasesTotal;
			config = addCatchUpDayWarning(config);
            config.data.labels = window.allLabels;
            var canvasId = "canvasCasesEveryoneTotalRaw";
            var ctx = document.getElementById(canvasId).getContext('2d');
            window.charts[canvasId] = new Chart(ctx, config);

            var config = getBaseConfig("  ", "New Deaths Per 1 Million Population");
			var pullFrom = getBaseConfig("US","US New Deaths PM", usData.data.datasets[0].deathsPerDayPM.slice());
			pullFrom.data.datasets[0].isDeath = true;
			pullFrom.data.datasets[0].isRolling = false;
            window.newDeathsPerCapita.unshift(pullFrom.data.datasets[0]);
			var pullFrom = getBaseConfig("US","US New Deaths PM Rolling", usData.data.datasets[0].deathsRollingPM.slice());
			pullFrom.data.datasets[0].isDeath = true;
			pullFrom.data.datasets[0].isRolling = true;
			pullFrom.data.datasets[0].hidden = true;
            window.newDeathsPerCapita.unshift(pullFrom.data.datasets[0]);
            config.data.datasets = window.newDeathsPerCapita;
			config = addCatchUpDayWarning(config);
            config.data.labels = window.allLabels;
            var canvasId = "canvasDeathEveryoneNDPM";
            var ctx = document.getElementById(canvasId).getContext('2d');
            window.charts[canvasId] = new Chart(ctx, config);
            
            var config = getBaseConfig("  ", "New Cases Per 1 Million Population");
			var pullFrom = getBaseConfig("US","US New Cases PM", usData.data.datasets[0].casesPerDayPM.slice());
			pullFrom.data.datasets[0].isCases = true;
			pullFrom.data.datasets[0].isRolling = false;
            window.newCasesPerCapita.unshift(pullFrom.data.datasets[0]);
			var pullFrom = getBaseConfig("US","US New Cases PM Rolling", usData.data.datasets[0].casesRollingPM.slice());
			pullFrom.data.datasets[0].isCases = true;
			pullFrom.data.datasets[0].isRolling = true;
			pullFrom.data.datasets[0].hidden = true;
            window.newCasesPerCapita.unshift(pullFrom.data.datasets[0]);
            config.data.datasets = window.newCasesPerCapita;
			config = addCatchUpDayWarning(config);
            config.data.labels = window.allLabels;
            var canvasId = "canvasCasesEveryoneNDPM";
            var ctx = document.getElementById(canvasId).getContext('2d');
            window.charts[canvasId] = new Chart(ctx, config);
            
            var canvasId = "canvasEveryoneallDatasets_DpcTotal";
            var config = getBaseConfig("  ", "Total Deaths as Percent Total Cases");
			usData.data.datasets[0].data = usData.data.datasets[0].deathPercentCasesTotal;
            window.allDatasets_DpcTotal.unshift(usData.data.datasets[0]);
            config.data.datasets = window.allDatasets_DpcTotal;
			config = addCatchUpDayWarning(config);
            config.data.labels = window.allLabels;
            config.options = 
			{
				responsive: true,
				title: {
					display: true,
					text: ''
				},
				tooltips: {
					intersect: false,
				},
				hover: {
					mode: 'nearest',
					intersect: true
				},
				legend: {
				  display: false
				},
				maintainAspectRatio: false,
				scales: {
					xAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Date'
						}
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: "Total Deaths as Percent Total Cases"
						}
					}]
				},
				tooltips:{
					mode: 'nearest',
					callbacks:{
						afterLabel:function(tooltipItem, data){
							return "Total Deaths:" + data.datasets[tooltipItem.datasetIndex].deathTotal[tooltipItem.index] + "\n Total Cases:" + data.datasets[tooltipItem.datasetIndex].caseTotal[tooltipItem.index];
						},
					}
				}
			};
            var ctx = document.getElementById(canvasId).getContext('2d');
            window.charts[canvasId] = new Chart(ctx, config);
            
            var dprc = getBaseConfig("", "Deaths percent of cases Rolling");
            var canvasId = "canvasEveryoneallDatasets_DpcRolling";
            dprc.data.datasets[0].label = "US";
            dprc.data.datasets[0].data = [];
            for(var adi = 0; adi < window.allDatasets_casesPerDayRaw.length/2; adi++){
			  var indivStateConfig = getBaseConfig(window.allDatasets_casesPerDayRaw[adi*2+1].label, "State case rolling");
			  indivStateConfig.data.datasets[0].data = [];
              for (var adid = 0; adid < window.allDatasets_deathsPerDayRaw[adi*2+1].data.length; adid++){
                if (adi == 0) { 
                  if (adid == 0){
                    dprc.data.datasets[0].caseRolling = [];
                    dprc.data.datasets[0].deathRolling = [];
                  }
                  dprc.data.datasets[0].caseRolling[adid] = dprc.data.datasets[0].deathRolling[adid] = dprc.data.datasets[0].data[adid] = 0;
                }
                if (adid == 0){
					indivStateConfig.data.datasets[0].caseRolling = [];
					indivStateConfig.data.datasets[0].deathRolling = [];
				}
				var stateCaseRolling = parseFloat(window.allDatasets_casesPerDayRaw[adi*2+1].data[adid]);
				var stateDeathRolling = parseFloat(window.allDatasets_deathsPerDayRaw[adi*2+1].data[adid]);
                dprc.data.datasets[0].caseRolling[adid] += stateCaseRolling;
                dprc.data.datasets[0].deathRolling[adid] += stateDeathRolling;
                dprc.data.datasets[0].data[adid] = ((100 * dprc.data.datasets[0].deathRolling[adid]) / dprc.data.datasets[0].caseRolling[adid]).toFixed(8);
				indivStateConfig.data.datasets[0].data[adid] = (100* stateDeathRolling / stateCaseRolling).toFixed(4);
				indivStateConfig.data.datasets[0].caseRolling[adid] = stateCaseRolling;
				indivStateConfig.data.datasets[0].deathRolling[adid] = stateDeathRolling;
              }
			  
			  indivStateConfig.data.datasets[0].isRolling = true;
			  indivStateConfig.data.datasets[0].isCases = true;
			  indivStateConfig.data.datasets[0].isDeath = true;
			  indivStateConfig.data.datasets[0].ignores7dayCB = true;
			  
			  window.allDatasets_DpcRolling.push(indivStateConfig.data.datasets[0]);
            }
            var config = getBaseConfig("  ", "Deaths as Percent Cases Rolling");
            config.data.datasets = window.allDatasets_DpcRolling;
			config = addCatchUpDayWarning(config);
            config.data.labels = window.allLabels;
            config.options = 
			{
				responsive: true,
				title: {
					display: true,
					text: ''
				},
				tooltips: {
					intersect: false,
				},
				hover: {
					mode: 'nearest',
					intersect: true
				},
				legend: {
				  display: false
				},
				maintainAspectRatio: false,
				scales: {
					xAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Date'
						}
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: "Rolling 7 day Deaths as Percent Cases"
						}
					}]
				},
				tooltips:{
					mode: 'nearest',
					callbacks:{
						afterLabel:function(tooltipItem, data){
							var toReturn = [];
							toReturn.push("Rolling 7 Avg Deaths:" + data.datasets[tooltipItem.datasetIndex].deathRolling[tooltipItem.index].toFixed(2));
							toReturn.push("Rolling 7 day Avg Cases:" + data.datasets[tooltipItem.datasetIndex].caseRolling[tooltipItem.index].toFixed(2));
						},
					}
				}
			};
			config = addCatchUpDayWarning(config);
            var ctx = document.getElementById(canvasId).getContext('2d');
            window.charts[canvasId] = new Chart(ctx, config);
        }
		shouldBeShowing = function(stateCode){
		  return jQuery("#statecb"+stateCode+":checked").length == 1;
		}
		useRollingAveragesWithCheckChart = function(useRolling, checkChart, index){
			if (typeof checkChart.data.datasets[index] == "undefined"){
			  console.log("No index:" + index + " on:");
			  console.log(checkChart);
			  return;
			}
			if (typeof checkChart.data.datasets[index].isRolling == "undefined") return;
			if (shouldBeShowing(checkChart.data.datasets[index].label)){
				var currentLineIsRolling = checkChart.data.datasets[index].isRolling;
				if (useRolling && currentLineIsRolling || !useRolling && !currentLineIsRolling){
					checkChart.getDatasetMeta(index).hidden = false;
				} else {
					checkChart.getDatasetMeta(index).hidden = true;
				}
			}
		}
		useRollingAverages = function(){
			useRolling = jQuery("#r7:checked").length == 1;
			for (var i = 0; i < 102; i++){
				useRollingAveragesWithCheckChart(useRolling, window.charts.canvasCasesEveryone, i);
				useRollingAveragesWithCheckChart(useRolling, window.charts.canvasDeathEveryone, i);
				useRollingAveragesWithCheckChart(useRolling, window.charts.canvasCasesEveryoneNDPM, i);
				useRollingAveragesWithCheckChart(useRolling, window.charts.canvasDeathEveryoneNDPM, i);
			}
			updateAll();
		}
		useSensibleAxisLimits = function(){
          if (jQuery("#uZ").prop("checked")){
		    if (typeof(window.charts.canvasDeathEveryone.config.options.scales.yAxes[0].ticks.min) == 'undefined'){
              window.charts.canvasDeathEveryone.config.options.scales.yAxes[0].ticks.min = 0;
              //window.charts.canvasDeathEveryone.config.options.scales.yAxes[0].ticks.max = 850;
			}
		    if (typeof(window.charts.canvasDeathEveryoneNDPM.config.options.scales.yAxes[0].ticks.min) == 'undefined'){
              window.charts.canvasDeathEveryoneNDPM.config.options.scales.yAxes[0].ticks.min = 0;
              //window.charts.canvasDeathEveryoneNDPM.config.options.scales.yAxes[0].ticks.max = 80;
			}
		    if (typeof(window.charts.canvasCasesEveryone.config.options.scales.yAxes[0].ticks.min) == 'undefined'){
              window.charts.canvasCasesEveryone.config.options.scales.yAxes[0].ticks.min = 0;
			}
		    if (typeof(window.charts.canvasCasesEveryoneNDPM.config.options.scales.yAxes[0].ticks.min) == 'undefined'){
              window.charts.canvasCasesEveryoneNDPM.config.options.scales.yAxes[0].ticks.min = 0;
              //window.charts.canvasCasesEveryoneNDPM.config.options.scales.yAxes[0].ticks.max = 1000;
			}
		    if (typeof(window.charts.canvasEveryoneallDatasets_DpcRolling.config.options.scales.yAxes[0].ticks.min) == 'undefined'){
              window.charts.canvasEveryoneallDatasets_DpcRolling.config.options.scales.yAxes[0].ticks.min = 0;
			}
			
          }
		  else {
			  Object.keys(window.charts).forEach(function(val, index){
			    delete window.charts[val].config.options.scales.yAxes[0].ticks.min;
			    delete window.charts[val].config.options.scales.yAxes[0].ticks.max;
			  });
		  }
		  updateAll();
        }
		
		updateAll = function(){
			useUsOnRaw();
			Object.keys(window.charts).forEach(function(val, index){
				if (jQuery(window.charts[val].canvas).is(":visible")){
					window.charts[val].update();
				}
			});
		}
		setStateByChart = function(chart, stateCode, isOn){
			if (isOn){
				turnOnStates(chart, [stateCode]);
			}else{
				turnOffStates(chart, [stateCode]);
			}
		}
		setState = function(stateCode, isOn, suppressUpdate){
		  if (isOn){
			  Object.keys(window.charts).forEach(function(val, index){
				turnOnStates(window.charts[val], [stateCode], suppressUpdate);
			  });
		  }else{
			  Object.keys(window.charts).forEach(function(val, index){
				turnOffStates(window.charts[val], [stateCode], suppressUpdate);
			  });
		  }
		}
		setStates = function(setStatesStateCodes){
			Object.keys(window.charts).forEach(function(val, index){
				turnOff(window.charts[val]);
			});
			Object.keys(window.charts).forEach(function(val, index){
				turnOnStates(window.charts[val], setStatesStateCodes);
			});
		}
		setStateCBs = function(setStatesStateCodes){
			jQuery("#stateCheckboxes input").each(function(a, b){
				if (setStatesStateCodes.indexOf(jQuery(b).attr("name")) > -1){
				  jQuery(b).prop("checked", "checked");
				}else{
				  jQuery(b).prop("checked", "");
				}
			});
		}
		stateClicked = function(item){
			setState(item.currentTarget.attributes.value.value, jQuery(item.currentTarget).prop("checked"), true);
			var statesChecked = "";
			jQuery("#stateCheckboxes input:checked").each(function(a, b){
			  statesChecked += ", " + jQuery(b).val();
			});
			if (statesChecked.length > 0){
			  statesChecked = statesChecked.substr(2)
			}
			jQuery("#stateList").text(statesChecked);
			setTextareaByCB();
			updateAll();
		}
        function doState(stateCode){
            jQuery.ajax({
                dataType: "json",
                url: "https://www.newsbreakapp.com/m/_api/events/virus/state-trend?stateCode="+stateCode,
                success: async function(data){
                    console.log("got this:");
                    console.log(data);
                    if (!data.trend){
                        console.log("No trend for:" + stateCode);
                        return;
                    }
					
                    var configdeathsPerDayRaw = getBaseConfig(stateCode, "New Deaths");
                    var configdeathsPerDayRawRolling = getBaseConfig(stateCode, "New Deaths 7 day rolling");
					
					var configcasesPerDayRaw = getBaseConfig(stateCode, "New Cases");
                    var configcasesPerDayRawRolling = getBaseConfig(stateCode, "New Cases 7 day rolling");
					
                    lastSevenDeaths = [0,0,0,0,0,0,0];
					lastSevenCases = [0,0,0,0,0,0,0];
					
					var configCasesPerCapita = getBaseConfig(stateCode, "Total Cases per capita");
                    
                    var configDeathsPerCapita = getBaseConfig(stateCode, "Total Deaths per capita");
                    
					var configCasesRaw = getBaseConfig(stateCode, "Cases Total");
                    
                    var configDeathsRaw = getBaseConfig(stateCode, "Deaths Total");
                    
                    var configDeathsNDPM = getBaseConfig(stateCode, "Deaths per Capita");
                    var configDeathsNDPMRolling = getBaseConfig(stateCode, "New Deaths per Capita 7 day rolling");
					
                    var configCasesNDPM = getBaseConfig(stateCode, "Cases per Capita");
                    var configCasesNDPMRolling = getBaseConfig(stateCode, "New Cases per Capita 7 day rolling");
                    
                    var configallDatasets_DpcTotal = getBaseConfig(stateCode, "Total Deaths as Percent Total Cases");
                    configallDatasets_DpcTotal.data.datasets[0].caseTotal = [];
                    configallDatasets_DpcTotal.data.datasets[0].deathTotal = [];
                    
                    
                    for (trendi = 0; trendi < data.trend.length -1; trendi++){
                        var trendDate = (data.trend[trendi].dt);
                        var trendDeathTotal = (data.trend[trendi].d);
                        var trendCaseTotal = data.trend[trendi].f;
                        // The daily new death charts were hard to follow with huge outliers.
                        // Catch-up days: unreported or recoded to be covid
                        // No state had a day over 820 deaths
                        // Negative catch-up: correcting double-counts or false positives 
                        // The negative numbers make charts hard to read.
                        // These caps WILL affect the 7 day trend line
                        // These will not affect anything that is based on totals
                        var trendDeathNew = (data.trend[trendi].d_b);
						var trendCaseNew = (data.trend[trendi].f_b);
						
                        lastSevenDeaths[trendi % lastSevenDeaths.length] = trendDeathNew;
                        lastSevenDeathsAvgTotal = lastSevenDeaths.reduce(function(a,b){ return a+b;},0);
                        lastSevenDeathsAvg = lastSevenDeathsAvgTotal / lastSevenDeaths.length;

						lastSevenCases[trendi % lastSevenCases.length] = trendCaseNew;
						lastSevenCasesAvgTotal = lastSevenCases.reduce(function(a,b){ return a+b;},0);
						lastSevenCasesAvg = lastSevenCasesAvgTotal / lastSevenCases.length;
						
						trendCaseNewRolling = lastSevenCasesAvg.toFixed(2);
						trendDeathNewRolling = lastSevenDeathsAvg.toFixed(2);

						configcasesPerDayRaw.data.labels.push(trendDate);
						configcasesPerDayRaw.data.datasets[0].data.push(trendCaseNew);
						
						configcasesPerDayRawRolling.data.labels.push(trendDate);
						configcasesPerDayRawRolling.data.datasets[0].data.push(trendCaseNewRolling);

                        configdeathsPerDayRaw.data.labels.push(trendDate);
                        configdeathsPerDayRaw.data.datasets[0].data.push(trendDeathNew);
						
						configdeathsPerDayRawRolling.data.labels.push(trendDate);
						configdeathsPerDayRawRolling.data.datasets[0].data.push(trendDeathNewRolling);
						
                        var deathPerCapitaTotal = trendDeathTotal / (statepop[stateCode])
                        configDeathsPerCapita.data.labels.push(trendDate);
                        configDeathsPerCapita.data.datasets[0].data.push(deathPerCapitaTotal.toFixed(8));

						var casePerCapitaTotal = trendCaseTotal / (statepop[stateCode])
						configCasesPerCapita.data.labels.push(trendDate);
						configCasesPerCapita.data.datasets[0].data.push(casePerCapitaTotal.toFixed(8));
						
                        configDeathsRaw.data.labels.push(trendDate);
                        configDeathsRaw.data.datasets[0].data.push(trendDeathTotal);

						configCasesRaw.data.labels.push(trendDate);
						configCasesRaw.data.datasets[0].data.push(trendCaseTotal);
						
						var deathsDayPerM = trendDeathNew * 1000000 / statepop[stateCode];
						var casesDayPerM = trendCaseNew * 1000000 / statepop[stateCode];
						
                        var lastSevenDeathsPM = lastSevenDeathsAvg * 1000000 / (statepop[stateCode]);
                        var lastSevenCasesPM = lastSevenCasesAvg * 1000000 / (statepop[stateCode]);
						
                        configDeathsNDPM.data.labels.push(trendDate);
                        configDeathsNDPM.data.datasets[0].data.push(deathsDayPerM.toFixed(4));
                        
                        configDeathsNDPMRolling.data.labels.push(trendDate);
                        configDeathsNDPMRolling.data.datasets[0].data.push(lastSevenDeathsPM.toFixed(4));
                        
                        configCasesNDPM.data.labels.push(trendDate);
                        configCasesNDPM.data.datasets[0].data.push(casesDayPerM.toFixed(4));
                        
                        configCasesNDPMRolling.data.labels.push(trendDate);
                        configCasesNDPMRolling.data.datasets[0].data.push(lastSevenCasesPM.toFixed(4));
                        
						var dpc = 0;
						if (trendCaseTotal != 0){
							dpc = trendDeathTotal * 100 / trendCaseTotal;
						}
                        configallDatasets_DpcTotal.data.datasets[0].data.push(dpc.toFixed(8));
                        configallDatasets_DpcTotal.data.datasets[0].caseTotal.push(trendCaseTotal);
                        configallDatasets_DpcTotal.data.datasets[0].deathTotal.push(trendDeathTotal);
                    }
                    
                    window.allLabels = configdeathsPerDayRaw.data.labels;
					
					configcasesPerDayRaw.data.datasets[0].isCases = true;
					configcasesPerDayRaw.data.datasets[0].isRolling = false;
					window.allDatasets_casesPerDayRaw.push(configcasesPerDayRaw.data.datasets[0]);
					configcasesPerDayRawRolling.data.datasets[0].isCases = true;
					configcasesPerDayRawRolling.data.datasets[0].hidden = true;
					configcasesPerDayRawRolling.data.datasets[0].isRolling = true;
                    window.allDatasets_casesPerDayRaw.push(configcasesPerDayRawRolling.data.datasets[0]);
                    
					configdeathsPerDayRaw.data.datasets[0].isRolling = false;
					configdeathsPerDayRaw.data.datasets[0].isDeath = true;
                    window.allDatasets_deathsPerDayRaw.push(configdeathsPerDayRaw.data.datasets[0]);
					configdeathsPerDayRawRolling.data.datasets[0].hidden = true;
					configdeathsPerDayRawRolling.data.datasets[0].isRolling = true;
					configdeathsPerDayRawRolling.data.datasets[0].isDeath = true;
                    window.allDatasets_deathsPerDayRaw.push(configdeathsPerDayRawRolling.data.datasets[0]);
                    
                    window.allDatasets_casesPerDayRawPerCapita.push(configCasesPerCapita.data.datasets[0]);
                    window.allDatasets_deathsPerDayRawPerCapita.push(configDeathsPerCapita.data.datasets[0]);
                    
                    window.allDatasets_DeathsTotal.push(configDeathsRaw.data.datasets[0]);
                    window.allDatasets_CasesTotal.push(configCasesRaw.data.datasets[0]);
                    
					configDeathsNDPM.data.datasets[0].isRolling = false;
					configDeathsNDPM.data.datasets[0].isDeath = true;
                    window.newDeathsPerCapita.push(configDeathsNDPM.data.datasets[0]);
					configDeathsNDPMRolling.data.datasets[0].hidden = true;
					configDeathsNDPMRolling.data.datasets[0].isRolling = true;
					configDeathsNDPMRolling.data.datasets[0].isDeath = true;
                    window.newDeathsPerCapita.push(configDeathsNDPMRolling.data.datasets[0]);
					
					configCasesNDPM.data.datasets[0].isRolling = false;
					configCasesNDPM.data.datasets[0].isCases = true;
                    window.newCasesPerCapita.push(configCasesNDPM.data.datasets[0]);
					configCasesNDPMRolling.data.datasets[0].hidden = true;
					configCasesNDPMRolling.data.datasets[0].isRolling = true;
					configCasesNDPMRolling.data.datasets[0].isCases = true;
                    window.newCasesPerCapita.push(configCasesNDPMRolling.data.datasets[0]);
                    
                    window.allDatasets_DpcTotal.push(configallDatasets_DpcTotal.data.datasets[0]);
                    
                    window.numStatesDone++;
                    jQuery("#statesDone").text(window.numStatesDone);
                }
            });
        }
		function addCatchUpDayWarning(config){
			var orig = function(){};
			if (typeof config.options.tooltips.callbacks == 'undefined'){
				config.options.tooltips.callbacks = {};
			}
			if (typeof config.options.tooltips.callbacks.afterLabel != 'undefined'){
				orig = config.options.tooltips.callbacks.afterLabel;
			}
			shouldCatchUpTextBeShown = function(catchUpDayLabel, type, tooltipItem, data){
				if (catchUpDayLabel == tooltipItem.xLabel){
					var showCatchUp = false;
					showCatchUp |= showCatchUp || (type == "death" && data.datasets[tooltipItem.datasetIndex].isDeath);
					showCatchUp |= showCatchUp || (type == "cases" && data.datasets[tooltipItem.datasetIndex].isCases);
					return showCatchUp;
				}
				return false;
			}
			config.options.tooltips.callbacks.afterLabel = function(tooltipItem, data){
				var mainText = orig(tooltipItem, data);
				var toReturn = [];
				if (typeof mainText == 'string'){
					toReturn.push(mainText);
				}
				if (typeof mainText == 'array'){
					toReturn = mainText;
				}
				var stateCode = data.datasets[tooltipItem.datasetIndex].label;
				var isRolling = (typeof data.datasets[tooltipItem.datasetIndex].isRolling != 'undefined') && data.datasets[tooltipItem.datasetIndex].isRolling;
				var catchUpDaysList = window.catchUpDays[stateCode];
				if (typeof catchUpDaysList != 'undefined'){
					if (isRolling){
						var showCatchUp = false;
						var catchUpDayToShow = "";
						//Do for 7 days
						for (i = 0; i < 7; i++){
							var dayCheck = (data.labels[tooltipItem.index - i]);
							var copyTooltipItem = Object.assign({}, tooltipItem);
							copyTooltipItem.xLabel = dayCheck;
							for(catchUpDayIndex = 0; catchUpDayIndex < catchUpDaysList.length; catchUpDayIndex++){
								var catchUpDayLabel = catchUpDaysList[catchUpDayIndex].day;
								var type = catchUpDaysList[catchUpDayIndex].type;
								showCatchUp |= (shouldCatchUpTextBeShown(catchUpDayLabel, type, copyTooltipItem, data) != false);
								if (showCatchUp && catchUpDayToShow == ""){
									catchUpDayToShow = dayCheck;
								}
							}
						}
						if (showCatchUp){
							toReturn.push("A 'catch-up' day occurred on:" + catchUpDayToShow);
							toReturn.push(" The reported number is an adjustment to correct totals.");
							toReturn.push(" This corrects the totals from prior missing or incorrect reports.");
							toReturn.push(" This affects the rolling data giving a 'plateau'");
						}
					}else{
						for(catchUpDayIndex = 0; catchUpDayIndex < catchUpDaysList.length; catchUpDayIndex++){
							var catchUpDayLabel = catchUpDaysList[catchUpDayIndex].day;
							var type = catchUpDaysList[catchUpDayIndex].type;
							var specialText = catchUpDaysList[catchUpDayIndex].specialText;
							var showCatchUp = shouldCatchUpTextBeShown(catchUpDayLabel, type, tooltipItem, data);
							if (showCatchUp == true){
								toReturn.push("This is a 'catch-up' day.");
								toReturn.push(" The reported number is an adjustment to correct totals.");
								toReturn.push(" This corrects the totals from prior missing or incorrect reports.");
							} else if (showCatchUp != false){  // If special text
								toReturn.push(specialText);
							}
						}
					}
				}
				return toReturn;
			}
			return config;
			
		}
		function addPercentOfToday(config){
			config.options.tooltips.callbacks = {
				afterLabel:function(tooltipItem, data){
					var toReturn = "Percent of current total by this day:";
					var mouseOverNum = parseFloat(tooltipItem.value);
					var todayNum = parseFloat(data.datasets[tooltipItem.datasetIndex].data[data.datasets[tooltipItem.datasetIndex].data.length-1]);
					var myPercent = 100 * mouseOverNum / todayNum;
					toReturn += myPercent.toFixed(2);
					toReturn += "%";
					return toReturn;
				},
			};
			return config;
		}
        function getBaseConfig(state, yAxisTitle, optionalData) {
			if (typeof optionalData == "undefined"){
			  optionalData = [];
			}
			optionalData = optionalData.slice();
            var config = {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
					    label: state,
                        backgroundColor: getStateColor(state),
                        borderColor: getStateColor(state),
                        data: optionalData,
                        fill: false,
                        pointRadius: 2,
                        pointHoverRadius: 5,
                        pointHitRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    title: {
                        display: true,
                        text: ''
                    },
                    tooltips: {
                        intersect: false
                    },
                    hover: {
                        mode: 'nearest',
                        intersect: true
                    },
                    legend: {
                      display: false
                    },
					maintainAspectRatio: false,
                    scales: {
                        xAxes: [{
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Date'
                            }
                        }],
                        yAxes: [{
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: yAxisTitle
                            }
                        }]
                    }
                }
            };
            return config;
        }

        window.onload = function() {
            doAllStates();
        };

    </script>
<div id="infoAxisLimits" style="float:left;padding: 30px;padding-top:70px;margin-bottom:100px;">
This data is obtained by your browser (not saved on the server of this page) from: <a href="https://www.newsbreak.com/topics/coronavirus">https://www.newsbreak.com/topics/coronavirus</a>
<br><br>
I found it annoying to try to compare states, so I started creating this.
<br><br>
<h3>Spikes, Plateaus, Negative Numbers</h3>
Daily data will have information that is used to "catch up" or "issue a correction" to the daily numbers. This causes huge spikes in daily numbers or negatives. But in order to understand the data it is easier to use axis sizes that stop at 0 and a lower number (such as NY/NJ daily death catch ups)

<br><br>
"Catch up" days are specific to state. Deaths and cases do not have the same "catch up" days.
<br><br>
What about the negative 7800+ cases for MA on 9/7? On September 2, 2020, MA reported that it had shifted to using the more restrictive August 6 definition of probable cases released by the CSTE. This change caused a significant decrease in several data points where probable cases or probable deaths were included, particularly the overall case count, which dropped by more than 7,000.
<br><br>
The "catch-up" days cause plateaus on rolling data as they are averaged out over the 7 day period.
<br><br>
For negative numbers, sometimes states can double-report or have cases that turns out the test itself was bad and therefore should not be counted as positive cases, so they correct the totals. The daily numbers are not considered as important as the totals.
<br><br>
9/23: I've started labelling known "catch up" days, but not all of them.
<br><br>
9/24: Added a way to get directly to a view you like
</div>

<div id="info7day" style="float:left;padding: 30px;padding-top:0px;margin-bottom:100px;">
<h3>Weekly Flux and 7 day rolling averages</h3>
Numbers are under-reported on the weekend, then Monday and Tuesdays typically report additional numbers from the weekend days. This creates wildly spiked charts, so instead, viewing a 7-day rolling window uses the average of the current day and the previous 6 days in order to smooth the numbers into a trend.
</div>
<div id="info7day" style="float:left;padding: 30px;padding-top:0px;margin-bottom:100px;">
<h3>Population data for Per Capita and Per Million Charts</h3>
State populations are estimates from wikipedia based on US Census data. In these charts, US data does not include Washington, DC. Instead US cases and US deaths is the sum from all of the states for each day. US population is the sum of the estimated populations of the states.
</div>
<h2>
Outdated - Oct 15:
Newsbreak.com has made their data more difficult to obtain. 
I didn't expect they would do this after months of easily obtaining the data. 
Until I get a suitable replacement, the graphs will not work.
In the meantime, this is the best alternative I've found for my kinds of charts:
<a href="https://covid.cdc.gov/covid-data-tracker/#compare-trends_newdeathsper100k">
https://covid.cdc.gov/covid-data-tracker/#compare-trends_newdeathsper100k
</a>
</h2>


</body>

</html>
